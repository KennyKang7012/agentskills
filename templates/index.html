<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FA å ±å‘Šå„ªåŒ–ç³»çµ± | Agent Skills</title>
    <link rel="stylesheet" href="/static/index.css">
</head>

<body>
    <div class="container">
        <h1>FA Report Improvement</h1>
        <p class="subtitle">åŸºæ–¼ 8D æ¨™æº–èˆ‡ LLM çš„åŠå°é«”å¤±æ•ˆåˆ†æå ±å‘Šè‡ªå‹•åŒ–å„ªåŒ–å¹³å°</p>

        <div style="margin-bottom: 2rem;">
            <label for="skill-select"
                style="display: block; margin-bottom: 10px; color: var(--text-secondary); font-weight: 500;">
                é¸æ“‡åŸ·è¡ŒæŠ€èƒ½:
            </label>
            <select id="skill-select" class="prompt-box" style="min-height: auto; padding: 0.75rem 1rem;">
                <option value="">-- è«‹é¸æ“‡æŠ€èƒ½ --</option>
            </select>
        </div>

        <div id="dynamic-inputs-container">
            <!-- å‹•æ…‹ç”Ÿæˆçš„è¼¸å…¥å…ƒä»¶å°‡æ³¨å…¥æ–¼æ­¤ -->
            <div
                style="text-align: center; padding: 3rem; color: var(--text-secondary); background: rgba(255,255,255,0.02); border-radius: 1rem; border: 2px dashed #475569;">
                è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡ä¸€é …æŠ€èƒ½ä»¥é–‹å§‹
            </div>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn" id="process-btn"
                style="background: var(--primary-hover); padding: 1rem 3rem; font-size: 1.2rem;"
                disabled>é–‹å§‹å„ªåŒ–å ±å‘Š</button>
        </div>

        <div class="status-panel" id="status-panel">
            <div class="loader"></div>
            <span id="status-text">æ­£åœ¨ä¸Šå‚³å ±å‘Š...</span>
        </div>

        <div id="result-area" style="margin-top: 2rem; display: none;">
            <h3>è™•ç†å®Œæˆï¼</h3>
            <p>å ±å‘Šå·²æŒ‰ç…§ 8D æ¨™æº–å„ªåŒ–ã€‚</p>
            <a href="#" class="btn" id="download-link">ä¸‹è¼‰å„ªåŒ–å¾Œçš„å ±å‘Š</a>
        </div>
    </div>

    <script>
        const skillSelect = document.getElementById('skill-select');
        const dynamicContainer = document.getElementById('dynamic-inputs-container');
        const processBtn = document.getElementById('process-btn');
        const statusPanel = document.getElementById('status-panel');
        const statusLoader = document.querySelector('.loader');
        const statusText = document.getElementById('status-text');
        const resultArea = document.getElementById('result-area');
        const downloadLink = document.getElementById('download-link');

        let currentManifest = null;
        let selectedFiles = {}; // å„²å­˜å‹•æ…‹æª”æ¡ˆå€‹é«”

        // 1. åˆå§‹åŒ–ï¼šç²å–æŠ€èƒ½åˆ—è¡¨
        async function initSkills() {
            try {
                const response = await fetch('/api/skills');
                const skills = await response.json();
                skills.forEach(skill => {
                    const option = document.createElement('option');
                    option.value = skill.id;
                    option.textContent = `${skill.name} (v${skill.version})`;
                    skillSelect.appendChild(option);
                });
            } catch (err) {
                console.error('ç„¡æ³•è¼‰å…¥æŠ€èƒ½åˆ—è¡¨:', err);
                updateUIError('åˆå§‹åŒ–å¤±æ•—', 'ç„¡æ³•å¾ä¼ºæœå™¨ç²å–æŠ€èƒ½æ¸…å–®');
            }
        }

        // 2. åˆ‡æ›æŠ€èƒ½ï¼šç²å– Manifest ä¸¦æ¸²æŸ“ UI
        skillSelect.addEventListener('change', async (e) => {
            const skillId = e.target.value;
            if (!skillId) {
                resetUI();
                return;
            }

            try {
                renderLoading('æ­£åœ¨åŠ è¼‰æŠ€èƒ½é…ç½®...');
                const response = await fetch(`/api/skills/${skillId}`);
                currentManifest = await response.json();
                renderSkillUI(currentManifest);
                statusPanel.classList.remove('active');
            } catch (err) {
                updateUIError('åŠ è¼‰å¤±æ•—', `ç„¡æ³•ç²å–æŠ€èƒ½ '${skillId}' çš„è¨­å®š`);
            }
        });

        function resetUI() {
            currentManifest = null;
            selectedFiles = {};
            dynamicContainer.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: var(--text-secondary); background: rgba(255,255,255,0.02); border-radius: 1rem; border: 2px dashed #475569;">
                    è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡ä¸€é …æŠ€èƒ½ä»¥é–‹å§‹
                </div>`;
            processBtn.disabled = true;
            resultArea.style.display = 'none';
        }

        function renderLoading(msg) {
            statusPanel.classList.add('active');
            statusText.innerText = msg;
            if (statusLoader) statusLoader.style.animation = 'spin 1.5s linear infinite';
        }

        // 3. å‹•æ…‹æ¸²æŸ“ä»‹é¢
        function renderSkillUI(manifest) {
            dynamicContainer.innerHTML = '';
            selectedFiles = {};

            const grid = document.createElement('div');
            grid.className = 'dynamic-grid';
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = manifest.inputs.filter(i => i.type === 'file').length > 1 ? '1fr 1fr' : '1fr';
            grid.style.gap = '20px';
            grid.style.marginBottom = '2rem';

            manifest.inputs.forEach(input => {
                const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '1.5rem';

                if (input.type === 'file') {
                    const zone = createUploadZone(input);
                    grid.appendChild(zone);
                } else if (input.type === 'text') {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.style.marginBottom = '10px';
                    label.style.color = 'var(--text-secondary)';
                    label.style.fontWeight = '500';
                    label.textContent = input.label;

                    const textarea = document.createElement('textarea');
                    textarea.id = `input-${input.id}`;
                    textarea.className = 'prompt-box';
                    textarea.placeholder = input.placeholder || '';

                    wrapper.appendChild(label);
                    wrapper.appendChild(textarea);
                    dynamicContainer.appendChild(wrapper);
                }
            });

            if (grid.children.length > 0) {
                dynamicContainer.prepend(grid);
            }
            checkInputs();
        }

        function createUploadZone(input) {
            const zone = document.createElement('div');
            zone.className = 'upload-area';
            zone.id = `zone-${input.id}`;
            zone.innerHTML = `
                <span class="upload-icon">${input.icon || 'ğŸ“'}</span>
                <p>${input.label}</p>
                <button class="btn" type="button">é¸æ“‡æª”æ¡ˆ</button>
                <input type="file" id="input-${input.id}" hidden accept="${input.accept || '*'}">
                <div id="name-${input.id}" class="file-name"></div>
            `;

            const realInput = zone.querySelector('input');
            const btn = zone.querySelector('.btn');
            const nameNode = zone.querySelector('.file-name');

            btn.onclick = () => realInput.click();
            realInput.onchange = (e) => handleFileSelection(e.target.files[0], input, nameNode, zone);

            // æ‹–æ‹½æ”¯æ´
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => {
                zone.addEventListener(eName, (e) => { e.preventDefault(); e.stopPropagation(); });
            });
            ['dragenter', 'dragover'].forEach(eName => zone.addEventListener(eName, () => zone.classList.add('dragging')));
            ['dragleave', 'drop'].forEach(eName => zone.addEventListener(eName, () => zone.classList.remove('dragging')));
            zone.addEventListener('drop', (e) => handleFileSelection(e.dataTransfer.files[0], input, nameNode, zone));

            return zone;
        }

        function handleFileSelection(file, inputSpec, nameNode, zone) {
            if (!file) return;
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            const allowed = (inputSpec.accept || '').split(',');

            if (allowed.includes(ext) || inputSpec.accept === '*') {
                selectedFiles[inputSpec.id] = file;
                nameNode.innerText = `å·²é¸æ“‡ï¼š${file.name}`;
                checkInputs();
            } else {
                alert(`ä¸æ”¯æ´çš„æ ¼å¼ï¼è«‹ä¸Šå‚³ï¼š${inputSpec.accept}`);
            }
        }

        function checkInputs() {
            if (!currentManifest) return;
            const requiredIds = currentManifest.inputs.filter(i => !i.optional).map(i => i.id);
            const allSet = requiredIds.every(id => {
                const inputSpec = currentManifest.inputs.find(i => i.id === id);
                if (inputSpec.type === 'file') return !!selectedFiles[id];
                const el = document.getElementById(`input-${id}`);
                return el && el.value.trim() !== '';
            });
            processBtn.disabled = !allSet;
        }

        // 4. æäº¤è¡¨å–®
        processBtn.addEventListener('click', async () => {
            if (!currentManifest) return;

            const formData = new FormData();
            currentManifest.inputs.forEach(input => {
                if (input.type === 'file') {
                    if (selectedFiles[input.id]) formData.append(input.id, selectedFiles[input.id]);
                } else {
                    const el = document.getElementById(`input-${input.id}`);
                    if (el) formData.append(input.id, el.value);
                }
            });

            try {
                renderLoading('æ­£åœ¨è™•ç†ä»»å‹™ï¼Œè«‹ç¨å€™...');
                resultArea.style.display = 'none';

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (response.ok && result.status === 'completed') {
                    statusPanel.classList.remove('active');
                    resultArea.style.display = 'block';
                    downloadLink.href = `/api/download/${result.output_file}`;
                } else {
                    updateUIError(result.error_type || 'åŸ·è¡Œå‡ºéŒ¯', result.message || 'ä¼ºæœå™¨è™•ç†å¤±æ•—');
                }
            } catch (err) {
                updateUIError('é€£ç·šç•°å¸¸', err.message);
            }
        });

        function updateUIError(type, msg) {
            statusPanel.classList.add('active');
            if (statusLoader) statusLoader.style.animation = 'none';
            statusText.innerHTML = `<span style="color: #ff5252; font-weight: bold;">${type}</span><br><small style="color: #fca5a5;">${msg}</small>`;
        }

        // å•Ÿå‹•
        initSkills();
    </script>
</body>

</html>