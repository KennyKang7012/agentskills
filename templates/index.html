<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FA å ±å‘Šå„ªåŒ–ç³»çµ± | Agent Skills</title>
    <link rel="stylesheet" href="/static/index.css">
</head>

<body>
    <div class="container">
        <h1>FA Report Improvement</h1>
        <p class="subtitle">åŸºæ–¼ 8D æ¨™æº–èˆ‡ LLM çš„åŠå°é«”å¤±æ•ˆåˆ†æå ±å‘Šè‡ªå‹•åŒ–å„ªåŒ–å¹³å°</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 2rem;">
            <div class="upload-area" id="ppt-zone">
                <span class="upload-icon">ğŸ“Š</span>
                <p>ä¸Šå‚³ FA å ±å‘Š (.ppt/pptx)</p>
                <button class="btn" onclick="document.getElementById('ppt-input').click()">é¸æ“‡æª”æ¡ˆ</button>
                <input type="file" id="ppt-input" hidden accept=".ppt,.pptx">
                <div id="ppt-name" class="file-name"></div>
            </div>

            <div class="upload-area" id="json-zone">
                <span class="upload-icon">ğŸ“œ</span>
                <p>ä¸Šå‚³è©•æ ¸ JSON (.json)</p>
                <button class="btn" onclick="document.getElementById('json-input').click()">é¸æ“‡æª”æ¡ˆ</button>
                <input type="file" id="json-input" hidden accept=".json">
                <div id="json-name" class="file-name"></div>
            </div>
        </div>

        <div style="margin-bottom: 2rem;">
            <label for="prompt-input"
                style="display: block; margin-bottom: 10px; color: var(--text-secondary); font-weight: 500;">
                å„ªåŒ–æç¤ºè© (é¸å¡«):
            </label>
            <textarea id="prompt-input" class="prompt-box" placeholder="ä¾‹å¦‚ï¼šç‰¹åˆ¥åŠ å¼·æ ¹å› åˆ†æéƒ¨åˆ†çš„çµ±è¨ˆæ•¸æ“šæ€§ï¼Œæˆ–æŒ‡å®šæ”¹å–„å°ç­–çš„å…·é«”æ–¹å‘..."></textarea>
        </div>

        <div style="text-align: center;">
            <button class="btn" id="process-btn"
                style="background: var(--primary-hover); padding: 1rem 3rem; font-size: 1.2rem;"
                disabled>é–‹å§‹å„ªåŒ–å ±å‘Š</button>
        </div>

        <div class="status-panel" id="status-panel">
            <div class="loader"></div>
            <span id="status-text">æ­£åœ¨ä¸Šå‚³å ±å‘Š...</span>
        </div>

        <div id="result-area" style="margin-top: 2rem; display: none;">
            <h3>è™•ç†å®Œæˆï¼</h3>
            <p>å ±å‘Šå·²æŒ‰ç…§ 8D æ¨™æº–å„ªåŒ–ã€‚</p>
            <a href="#" class="btn" id="download-link">ä¸‹è¼‰å„ªåŒ–å¾Œçš„å ±å‘Š</a>
        </div>
    </div>

    <script>
        const pptInput = document.getElementById('ppt-input');
        const jsonInput = document.getElementById('json-input');
        const promptInput = document.getElementById('prompt-input');
        const pptName = document.getElementById('ppt-name');
        const jsonName = document.getElementById('json-name');
        const processBtn = document.getElementById('process-btn');

        const statusPanel = document.getElementById('status-panel');
        const statusLoader = document.querySelector('.loader');
        const statusText = document.getElementById('status-text');
        const resultArea = document.getElementById('result-area');
        const downloadLink = document.getElementById('download-link');

        let selectedPpt = null;
        let selectedJson = null;

        // --- æ‹–æ‹½åŠŸèƒ½å¯¦ä½œ ---
        const zones = [
            { el: document.getElementById('ppt-zone'), input: pptInput, accept: ['.ppt', '.pptx'], setter: (f) => selectedPpt = f, nameNode: pptName },
            { el: document.getElementById('json-zone'), input: jsonInput, accept: ['.json'], setter: (f) => selectedJson = f, nameNode: jsonName }
        ];

        zones.forEach(zone => {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                zone.el.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                zone.el.addEventListener(eventName, () => {
                    zone.el.classList.add('dragging');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                zone.el.addEventListener(eventName, () => {
                    zone.el.classList.remove('dragging');
                }, false);
            });

            zone.el.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                handleFileSelection(file, zone);
            }, false);
        });

        function handleFileSelection(file, zone) {
            if (!file) return;

            const ext = '.' + file.name.split('.').pop().toLowerCase();
            if (zone.accept.includes(ext)) {
                zone.setter(file);
                zone.nameNode.innerText = `å·²é¸æ“‡ï¼š${file.name}`;
                checkInputs();
            } else {
                alert(`ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼è«‹ä¸Šå‚³ç¯„ç–‡å…§çš„æ–‡ä»¶ï¼š${zone.accept.join(', ')}`);
            }
        }

        function updateUIError(type, msg) {
            statusPanel.classList.add('active');
            if (statusLoader) statusLoader.style.animation = 'none';
            statusText.innerHTML = `<span style="color: #ff5252; font-weight: bold;">${type}</span><br><small style="color: #fca5a5;">${msg}</small>`;
        }

        pptInput.addEventListener('change', (e) => {
            handleFileSelection(e.target.files[0], zones[0]);
        });

        jsonInput.addEventListener('change', (e) => {
            handleFileSelection(e.target.files[0], zones[1]);
        });

        function checkInputs() {
            processBtn.disabled = !(selectedPpt && selectedJson);
        }

        processBtn.addEventListener('click', async () => {
            try {
                if (!selectedPpt || !selectedJson) return;

                const formData = new FormData();
                formData.append('report', selectedPpt);
                formData.append('evaluation_json', selectedJson);
                formData.append('prompt', promptInput.value);

                // é‡è¨­ç‹€æ…‹é¢æ¿
                statusPanel.classList.add('active');
                resultArea.style.display = 'none';
                statusText.innerText = 'æ­£åœ¨åˆ†æä¸¦å„ªåŒ–å ±å‘Š...';
                if (statusLoader) statusLoader.style.animation = 'spin 1.5s linear infinite';

                // 1. å‰ç«¯ JSON èªæ³•é æª¢ (æ™ºæ…§å®¹éŒ¯æ¨¡å¼)
                try {
                    const jsonText = await selectedJson.text();
                    JSON.parse(jsonText);
                } catch (e) {
                    // åµæ¸¬åˆ°èªæ³•éŒ¯èª¤ï¼Œä½†æˆ‘å€‘é¸æ“‡ç›¸ä¿¡å¾Œç«¯çš„ã€Œè‡ªå‹•æ¸…æ´—ã€èƒ½åŠ›
                    console.warn('å‰ç«¯åµæ¸¬åˆ° JSON èªæ³•ç–‘æ…®ï¼Œå˜—è©¦äº¤ç”±å¾Œç«¯è‡ªå‹•ä¿®æ­£:', e.message);
                    statusText.innerHTML = `æ­£åœ¨åˆ†æä¸¦å„ªåŒ–å ±å‘Š...<br><small style="color: #818cf8;">(åµæ¸¬åˆ° JSON æ ¼å¼ç‘•ç–µï¼Œå·²å•Ÿå‹•è‡ªå‹•å®¹éŒ¯ä¿®å¾©æ¨¡å¼)</small>`;
                }

                // 2. å‚³é€è«‹æ±‚ (è®“å¾Œç«¯ Regex ç™¼æ®ä½œç”¨)
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.status === 'completed') {
                    statusPanel.classList.remove('active');
                    resultArea.style.display = 'block';
                    downloadLink.href = `/api/download/${result.output_file}`;
                } else {
                    const errorMsg = result.message || 'ä¼ºæœå™¨è™•ç†å¤±æ•—';
                    const errorType = result.error_type || 'è™•ç†å‡ºéŒ¯';
                    updateUIError(errorType, errorMsg);
                }
            } catch (err) {
                console.error(err);
                updateUIError('ç³»çµ±é€£ç·šç•°å¸¸', err.message || 'ç„¡æ³•èˆ‡ä¼ºæœå™¨é€šè¨Š');
            }
        });
    </script>
</body>

</html>